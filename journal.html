<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Journal - Hanuman Bank</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Hanuman Bank</h1>
            <p>Personal Journal</p>
        </header>
        
        <div class="auth-check hidden">
            <div class="message error">
                <h2>Access Restricted</h2>
                <p>Only registered users can access this page.</p>
                <p>Please <a href="register.html">register</a> or <a href="login.html">login</a> to continue.</p>
            </div>
        </div>

        <div class="journal-interface hidden">
            <div class="user-welcome">
                <h2>Welcome to your Journal, <span id="usernameDisplay"></span>!</h2>
                <p>Write your thoughts, ideas, and notes. All entries are saved with timestamps.</p>
            </div>

            <div class="journal-container">
                <div class="journal-editor">
                    <textarea id="journalEntry" placeholder="Write your journal entry here..."></textarea>
                    <div class="editor-actions">
                        <button id="saveBtn">Save Entry</button>
                        <span id="saveStatus"></span>
                    </div>
                </div>

                <div class="journal-entries">
                    <h3>Your Journal Entries</h3>
                    <div id="entriesList">
                        <p class="no-entries">No journal entries yet. Start writing above!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API configuration
        const API_KEY = '$2a$10$uxQT/K0GQROTIeDYxqITXuqLD3tJVCBKx1KumopS8c5yx6Dwy4adG';
        const BIN_ID = '68b4193a43b1c97be931e99b';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // DOM elements
        const authCheck = document.querySelector('.auth-check');
        const journalInterface = document.querySelector('.journal-interface');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const journalEntry = document.getElementById('journalEntry');
        const saveBtn = document.getElementById('saveBtn');
        const saveStatus = document.getElementById('saveStatus');
        const entriesList = document.getElementById('entriesList');

        // Current user and journal data
        let currentUser = null;
        let userJournalData = null;

        // Check authentication and initialize page
        async function initPage() {
            // Check if user is logged in (from localStorage)
            const userData = localStorage.getItem('currentUser');
            
            if (!userData) {
                // User is not logged in
                authCheck.classList.remove('hidden');
                return;
            }
            
            currentUser = JSON.parse(userData);
            journalInterface.classList.remove('hidden');
            usernameDisplay.textContent = currentUser.username;
            
            // Load user's journal data
            await loadUserJournalData();
            
            // Display existing entries
            displayJournalEntries();
            
            // Set up event listeners
            setupEventListeners();
        }

        // Load user's journal data from database
        async function loadUserJournalData() {
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }
                
                const data = await response.json();
                const users = data.record.users || [];
                
                // Find current user's data
                const userData = users.find(user => user.username === currentUser.username);
                
                if (userData && userData.journalEntries) {
                    userJournalData = userData.journalEntries;
                } else {
                    userJournalData = [];
                }
            } catch (error) {
                console.error('Error loading journal data:', error);
                userJournalData = [];
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            saveBtn.addEventListener('click', saveJournalEntry);
            
            // Auto-save when user presses Ctrl+Enter
            journalEntry.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    saveJournalEntry();
                }
            });
        }

        // Save journal entry
        async function saveJournalEntry() {
            const entryText = journalEntry.value.trim();
            
            // Validate entry
            if (!entryText) {
                alert('Please write something in your journal before saving');
                return;
            }
            
            // Create new entry
            const newEntry = {
                id: Date.now(), // Unique ID based on timestamp
                content: entryText,
                timestamp: new Date().toISOString()
            };
            
            // Add to journal data
            userJournalData.unshift(newEntry); // Add to beginning of array (newest first)
            
            // Save to database
            const success = await saveJournalData();
            
            if (success) {
                // Clear textarea
                journalEntry.value = '';
                
                // Show success message
                showSaveStatus('Entry saved successfully!', 'success');
                
                // Update entries list
                displayJournalEntries();
            } else {
                showSaveStatus('Error saving entry. Please try again.', 'error');
            }
        }

        // Display journal entries
        function displayJournalEntries() {
            if (userJournalData.length === 0) {
                entriesList.innerHTML = '<p class="no-entries">No journal entries yet. Start writing above!</p>';
                return;
            }
            
            entriesList.innerHTML = '';
            
            userJournalData.forEach(entry => {
                const entryElement = createJournalEntryElement(entry);
                entriesList.appendChild(entryElement);
            });
        }

        // Create journal entry element
        function createJournalEntryElement(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'journal-entry';
            entryDiv.dataset.id = entry.id;
            
            const entryDate = new Date(entry.timestamp);
            const formattedDate = entryDate.toLocaleString();
            
            entryDiv.innerHTML = `
                <div class="entry-content">${escapeHtml(entry.content)}</div>
                <div class="entry-date">${formattedDate}</div>
                <button class="delete-entry" data-id="${entry.id}">Delete</button>
            `;
            
            // Add delete functionality
            const deleteBtn = entryDiv.querySelector('.delete-entry');
            deleteBtn.addEventListener('click', () => {
                deleteJournalEntry(entry.id);
            });
            
            return entryDiv;
        }

        // Delete journal entry
        async function deleteJournalEntry(entryId) {
            if (!confirm('Are you sure you want to delete this journal entry?')) {
                return;
            }
            
            // Remove entry from data
            userJournalData = userJournalData.filter(entry => entry.id !== entryId);
            
            // Save to database
            const success = await saveJournalData();
            
            if (success) {
                // Update entries list
                displayJournalEntries();
                showSaveStatus('Entry deleted successfully!', 'success');
            } else {
                showSaveStatus('Error deleting entry. Please try again.', 'error');
            }
        }

        // Save journal data to database
        async function saveJournalData() {
            try {
                // First get existing users
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }
                
                const data = await response.json();
                const users = data.record.users || [];
                
                // Find current user and update their journal data
                const userIndex = users.findIndex(user => user.username === currentUser.username);
                
                if (userIndex !== -1) {
                    users[userIndex].journalEntries = userJournalData;
                } else {
                    // This shouldn't happen if user is logged in, but just in case
                    users.push({
                        username: currentUser.username,
                        email: currentUser.email,
                        journalEntries: userJournalData
                    });
                }
                
                // Update the database
                const updateResponse = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ users })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to save journal data');
                }
                
                return true;
            } catch (error) {
                console.error('Error saving journal data:', error);
                return false;
            }
        }

        // Show save status message
        function showSaveStatus(message, type) {
            saveStatus.textContent = message;
            saveStatus.className = type;
            
            // Clear message after 3 seconds
            setTimeout(() => {
                saveStatus.textContent = '';
                saveStatus.className = '';
            }, 3000);
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', initPage);

        // Developer tools protection (basic)
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        document.addEventListener('keydown', (e) => {
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+U
            if (
                e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'U')
            ) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
